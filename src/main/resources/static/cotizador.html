<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Prepagas San Juan – Cotizador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1e3a8a">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand-blue: #1e3a8a;
      --brand-teal: #12c6c9;
      --brand-mint: #21c78a;
      --green: var(--brand-teal);
      --muted: #6b7280;
      --light-gray: #f1f5f9;
      --ink: #0f172a;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', sans-serif;
      background: #fff;
      color: var(--ink);
      margin: 0;
      padding: 2rem 1rem;
    }
    .form-wrapper { max-width: 960px; margin: auto; }
    h1 { text-align: center; color: var(--brand-blue); margin-bottom: 2rem; }

    /* ===== Selector de grupo familiar ===== */
    .grupo-familiar-selector {
      display: flex; gap: 1rem; justify-content: center;
      margin-bottom: 2rem; flex-wrap: wrap;
    }
    .opcion-familiar {
      padding: 0.6rem 1.4rem; border: 2px solid var(--brand-blue);
      background: white; color: var(--brand-blue); border-radius: 8px;
      font-weight: 600; cursor: pointer;
      transition: background .25s var(--ease), color .25s var(--ease);
    }
    .opcion-familiar:hover { background: var(--brand-blue); color: white; }
    .opcion-familiar.seleccionada {
      background: linear-gradient(135deg, var(--brand-mint), var(--brand-teal));
      color: white; border-color: transparent;
      box-shadow: 0 8px 24px -10px rgba(30,58,138,.35);
    }
    .hidden { display: none !important; }

    /* ===== Grid (3 columnas) ===== */
    form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }

    /* Apariencia de campos con animaciones */
    .form-group { display: flex; flex-direction: column; opacity: 0; transform: translateY(6px); animation: enter .5s var(--ease) forwards; }
    .form-group:nth-of-type(1){animation-delay:.02s} .form-group:nth-of-type(2){animation-delay:.06s} .form-group:nth-of-type(3){animation-delay:.1s}
    .form-group:nth-of-type(4){animation-delay:.14s} .form-group:nth-of-type(5){animation-delay:.18s} .form-group:nth-of-type(6){animation-delay:.22s}
    .form-group:nth-of-type(7){animation-delay:.26s} .form-group:nth-of-type(8){animation-delay:.30s}

    label { font-weight: 600; color: var(--brand-blue); font-size: 0.9rem; margin-bottom: 0.35rem; }

    input, select {
      border: none; outline: none; background: transparent; color: var(--ink);
      padding: 0.55rem 0.25rem; font-size: 1rem; position: relative;
      border-bottom: 2px solid #d1d5db;
      transition: border-color .22s var(--ease), transform .18s var(--ease), background-size .22s var(--ease);
      background-image: linear-gradient(90deg, var(--brand-mint), var(--brand-teal));
      background-repeat: no-repeat; background-size: 0% 2px; background-position: 0 100%;
    }
    input::placeholder { color: var(--muted); }
    input:focus, select:focus { border-color: transparent; background-size: 100% 2px; transform: translateY(-1px); }

    input:disabled, select:disabled {
      opacity: .6; cursor: not-allowed;
      background-image: none; border-bottom: 2px dashed #e5e7eb;
    }

    .full-width { grid-column: 1 / -1; }

    /* Botones */
    .actions { grid-column: 1 / -1; display: flex; justify-content: start; gap: 1.2rem; margin-top: .25rem; }
    .btn {
      position: relative; overflow: hidden; isolation: isolate;
      padding: .7rem 1.6rem; border: 2px solid var(--brand-blue); background: #fff; color: var(--brand-blue);
      font-weight: 700; font-size: 1rem; border-radius: 12px; cursor: pointer;
      transition: transform .16s var(--ease), background .2s var(--ease), color .2s var(--ease), box-shadow .2s var(--ease), border-color .2s var(--ease);
    }
    .btn:hover { background: linear-gradient(135deg, var(--brand-mint), var(--brand-teal)); color: #fff; border-color: transparent; box-shadow: 0 12px 26px -16px rgba(30,58,138,.45); }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn.secondary { background: #fff; color: var(--brand-blue); }
    .btn.loading { pointer-events:none; opacity:.95 }
    .btn.loading::after { content:''; position:absolute; right:12px; top:50%; width:16px; height:16px; border:2px solid currentColor; border-right-color:transparent; border-radius:50%; transform:translateY(-50%); animation: spin .8s linear infinite; }

    .ripple { position:absolute; inset:auto; width:8px; height:8px; border-radius:50%; background: currentColor; opacity:.18; transform: translate(-50%, -50%) scale(1); animation: ripple .6s ease-out forwards; pointer-events:none; z-index:-1; }

    /* Iconos en los tabs */
    .opcion-familiar { display: inline-flex; align-items: center; gap: .6rem; }
    .fam-icon { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; line-height: 0; }
    .opcion-familiar svg { width: 100%; height: 100%; }
    @media (max-width: 560px){ .opcion-familiar { flex-direction: column; gap: .35rem; } .fam-icon { width: 32px; height: 32px; } }

    /* Tabla/Grilla */
    .table-card { margin-top: 1.75rem; border-radius: 5px; overflow: hidden; background: #fff; border: 1px solid #e2e8f0; box-shadow: 0 18px 44px -26px rgba(15,23,42,.35), 0 10px 22px -16px rgba(15,23,42,.18); padding:16px; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { text-align: left; padding: 10px 14px; }
    thead { background: linear-gradient(90deg, var(--brand-teal) 0%, var(--brand-blue) 100%); color: white; font-weight: 700; letter-spacing:.2px }
    tbody { background: var(--light-gray); }
    tbody tr { transition: background .2s var(--ease); }
    tbody tr:hover { background: #edfafa; }

    /* columnas (como el boceto) */
    col.col-proveedor { width: 30%; }
    col.col-plan      { width: 28%; }
    col.col-num       { width: 18%; }
    col.col-estado    { width: 16%; }
    col.col-detalle   { width: 8%;  }

    col.col-proveedor { width: 12%; }
    col.col-plan      { width: 12%; }
    col.col-num       { width: 12%; }
    col.col-estado    { width: 12%; }
    col.col-detalle   { width: 12%;  }

    /* números tabulares */
    th.num, td.num { text-align: left; white-space: nowrap; font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    td.price-final { font-weight: 800; color: var(--brand-blue); }

    /* Estado en texto */
    td.estado { text-align: left; }

    /* Link "Ver detalle" */
    .link-detalle{
      color: var(--brand-blue);
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .link-detalle:hover{ text-decoration: underline; }

    /* Skeleton y animaciones */
    .skeleton { position: relative; height: 18px; border-radius: 6px; overflow: hidden; background: #e5e7eb; }
    .skeleton::after { content:''; position:absolute; inset:0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,.7), transparent); animation: shimmer 1.1s infinite; }
    .row-in { opacity:0; transform: translateY(6px); animation: rowIn .45s var(--ease) forwards; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,.5); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
    .modal-backdrop.show { display:flex; }
    .modal { width: 100%; max-width: 680px; background: #fff; border-radius: 16px; box-shadow: 0 30px 60px -20px rgba(2,6,23,.45); overflow: hidden; transform: scale(.98) translateY(6px); opacity: 0; animation: modalIn .24s var(--ease) forwards; }
    .modal header { display:flex; align-items:center; justify-content:space-between; padding: 14px 18px; background: linear-gradient(90deg, var(--brand-teal), var(--brand-blue)); color:#fff; }
    .modal .content { padding: 16px 18px 20px; line-height: 1.55; }
    .modal .grid { display:grid; grid-template-columns: 1fr 1fr; gap: .5rem 1rem; }
    .modal .label { color:#475569; font-weight:600; }
    .modal .value { text-align:right; font-variant-numeric: tabular-nums; }
    .modal .total { font-size:1.05rem; font-weight:800; color: var(--brand-blue); text-align:right; }
    .close-btn { background: transparent; border: 0; color: #fff; font-weight: 800; font-size: 1.1rem; cursor: pointer; }

    @keyframes enter { to { opacity:1; transform:none } }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
    @keyframes rowIn { to { opacity:1; transform:none } }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    @keyframes ripple { to { transform: translate(-50%, -50%) scale(24); opacity:0; } }
    @keyframes modalIn { to { opacity:1; transform: none; } }

    /* Ajustes finos de grilla */
    col.col-proveedor { width: 30%; }
    col.col-plan      { width: 28%; }
    col.col-num       { width: 18%; }
    col.col-estado    { width: 16%; }
    col.col-detalle   { width: 8%; }

    /* Separador sutil entre filas */
    tbody tr + tr td { border-top: 1px solid #e5e7eb; }

    /* Alineaciones */
    th:nth-child(3), td:nth-child(3) { text-align: right; }
    td:nth-child(4) { text-align: left;  white-space: nowrap; }
    td:nth-child(5) { text-align: right; white-space: nowrap; }

    td:nth-child(1), td:nth-child(2) {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .link-detalle{ color: var(--brand-blue); font-weight: 700; text-decoration: none; cursor: pointer; }
    .link-detalle:hover { text-decoration: underline; }

    col.col-detalle { width: 120px; }
    td:nth-child(5) { text-align: right; white-space: nowrap; overflow: visible; }

    @media (max-width: 640px){
      table { table-layout: auto; }
      col.col-detalle { width: auto; }
      th, td { padding: 8px 10px; }
    }

    /* Empty state */
    .empty-state{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px; text-align:center; padding:32px 16px; border:1.5px dashed #cbd5e1; border-radius:12px;
      background:linear-gradient(180deg,#f8fafc,#f1f5f9); color:#475569;
    }
    .empty-state svg{ opacity:.6; }
    .empty-title{ margin:4px 0 0; font-weight:600; }
    .empty-sub{ margin:0; font-size:.95rem; color:#64748b; }
  </style>
</head>
<body>
  <div class="form-wrapper">
    <h1>Prepagas San Juan – Cotizador</h1>

    <!-- Selector de grupo familiar -->
    <div class="grupo-familiar-selector">
      <button type="button" class="opcion-familiar seleccionada" data-tipo="solo" aria-pressed="true">
        <span class="fam-icon" aria-hidden="true">
          <!-- Solo -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="7" r="3"></circle>
            <path d="M5 21c0-3.3 3.6-6 7-6s7 2.7 7 6"></path>
          </svg>
        </span>
        <span>Para mí</span>
      </button>
      
      <button type="button" class="opcion-familiar" data-tipo="pareja" aria-pressed="false">
        <span class="fam-icon" aria-hidden="true">
          <!-- Pareja -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="8" cy="7" r="3"></circle>
            <circle cx="16" cy="7" r="3"></circle>
            <path d="M2.5 21c0-3 2.8-5.5 5.5-5.5"></path>
            <path d="M21.5 21c0-3-2.8-5.5-5.5-5.5"></path>
          </svg>
        </span>
        <span>Para mí y mi pareja</span>
      </button>

      <button type="button" class="opcion-familiar" data-tipo="hijos" aria-pressed="false">
        <span class="fam-icon" aria-hidden="true">
          <!-- Adulto + hijo -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="6.5" r="3"></circle>
            <path d="M3 21c0-3.5 3-6 6-6s6 2.5 6 6"></path>
            <circle cx="18" cy="10.5" r="2"></circle>
            <path d="M16 21c0-2.2 1.8-4 4-4"></path>
          </svg>
        </span>
        <span>Para mí y mis hijos</span>
      </button>

      <button type="button" class="opcion-familiar" data-tipo="familia" aria-pressed="false">
        <span class="fam-icon" aria-hidden="true">
          <!-- Familia -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="7" cy="6.5" r="3"></circle>
            <circle cx="17" cy="6.5" r="3"></circle>
            <path d="M2.5 21c0-3 2.8-5.5 5.5-5.5"></path>
            <path d="M21.5 21c0-3-2.8-5.5-5.5-5.5"></path>
            <circle cx="12" cy="11.5" r="2"></circle>
            <path d="M9.5 21c0-2.2 2.1-4 4.5-4"></path>
          </svg>
        </span>
        <span>Para mí y mi familia</span>
      </button>
    </div>

    <!-- Formulario -->
    <form id="formCotizador">
      <input type="hidden" id="tipoGrupo" value="solo" />

      <div class="form-group" id="grpEdadTitular">
        <label for="edadTitular">Edad titular</label>
        <input id="edadTitular" type="number" min="0" placeholder="" />
      </div>

      <div class="form-group" id="grpGeneroTitular">
        <label for="genero">Género titular</label>
        <select id="genero">
          <option value="" disabled selected>Seleccionar</option>
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </div>

      <!-- Pareja -->
      <div class="form-group hidden" id="grpEdadPareja">
        <label for="edadPareja">Edad pareja</label>
        <input id="edadPareja" type="number" min="0" placeholder="" disabled />
      </div>
      <div class="form-group hidden" id="grpGeneroPareja">
        <label for="generoPareja">Género pareja</label>
        <select id="generoPareja" disabled>
          <option value="" disabled selected>Seleccionar</option>
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </div>

      <!-- Hijos -->
      <div class="form-group hidden" id="grpCantidadHijos">
        <label for="cantidadHijos">Cantidad de hijos</label>
        <input id="cantidadHijos" type="number" min="1" placeholder="0" disabled />
      </div>

      <div class="form-group">
        <label for="afiliacion">Afiliación</label>
        <select id="afiliacion">
          <option value="" disabled selected>Seleccionar</option>
          <option value="1">Relación de dependencia</option>
          <option value="2">Monotributista</option>
          <option value="3">Particular</option>
        </select>
      </div>

      <div class="form-group">
        <label for="sueldo">Sueldo Bruto en $</label>
        <input id="sueldo" type="number" step="0.01" placeholder="0.00" disabled title="Disponible solo para relación de dependencia" />
      </div>

      <div class="actions">
        <button class="btn" id="btnCotizar" type="submit">Obtener cotización</button>
        <button class="btn secondary" id="btnLimpiar" type="button">Limpiar</button>
      </div>
    </form>

    <!-- Grilla de resultados -->
    <div class="table-card">
      <!-- Empty state visible al inicio -->
      <div id="emptyState" class="empty-state">
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 14a1 1 0 1 1-1 1 1 1 0 0 1 1-1Zm1-3h-2a1 1 0 0 1-1-1V7a1 1 0 0 1 2 0v4h1a1 1 0 0 1 0 2Z"/></svg>
        <p class="empty-title">Todavía no se realizaron cotizaciones</p>
        <p class="empty-sub">Completá el formulario y tocá <strong>“Obtener cotización”</strong>.</p>
      </div>

      <table id="tablaResultados" hidden>
        <colgroup>
          <col class="col-proveedor" />
          <col class="col-plan" />
          <col class="col-num" />
          <col class="col-estado" />
          <col class="col-detalle" />
        </colgroup>
        <thead>
          <tr>
            <th>Proveedor</th>
            <th>Planes</th>
            <th class="num">Precio final</th>
            <th>Estado</th>
            <th>Detalle</th>
          </tr>
        </thead>
        <tbody id="tbodyResultados"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de detalle -->
  <div id="detalleBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detalleTitulo">
      <header>
        <h3 id="detalleTitulo" style="margin:0;font-size:1.05rem;">Detalle del plan</h3>
        <button class="close-btn" type="button" id="cerrarDetalle">&times;</button>
      </header>
      <div class="content" id="detalleContenido">
        <!-- Se completa vía JS -->
      </div>
    </div>
  </div>

  <script>
    // Ripple en botones principales
    function attachRipple(btn){
      btn.addEventListener('click', (e)=>{
        const r = document.createElement('span');
        r.className = 'ripple';
        const rect = btn.getBoundingClientRect();
        r.style.left = (e.clientX - rect.left) + 'px';
        r.style.top  = (e.clientY - rect.top)  + 'px';
        btn.appendChild(r);
        setTimeout(()=> r.remove(), 650);
      });
    }
    document.querySelectorAll('.btn, .opcion-familiar').forEach(attachRipple);

    // Helpers
    function setVisible(groupId, show){
      const el = document.getElementById(groupId);
      if(!el) return;
      el.classList.toggle('hidden', !show);
      el.querySelectorAll('input, select').forEach(i => i.disabled = !show);
    }
    function computeCantidad(tipo, cantHijos){
      if (tipo === 'solo')   return 1;
      if (tipo === 'pareja') return 2;
      if (tipo === 'hijos')  return 1 + (cantHijos || 0);
      if (tipo === 'familia')return 2 + (cantHijos || 0);
      return 1;
    }

    // Manejo de selección familiar
    function aplicarTipo(tipo){
      setVisible('grpEdadTitular', true);
      setVisible('grpGeneroTitular', true);
      setVisible('grpEdadPareja', false);
      setVisible('grpGeneroPareja', false);
      setVisible('grpCantidadHijos', false);

      if(tipo === 'pareja'){
        setVisible('grpEdadPareja', true);
        setVisible('grpGeneroPareja', true);
      } else if(tipo === 'hijos'){
        setVisible('grpCantidadHijos', true);
      } else if(tipo === 'familia'){
        setVisible('grpEdadPareja', true);
        setVisible('grpGeneroPareja', true);
        setVisible('grpCantidadHijos', true);
      }
      document.getElementById('tipoGrupo').value = tipo;
    }
    document.querySelectorAll('.opcion-familiar').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.opcion-familiar').forEach(b => b.classList.remove('seleccionada'));
        btn.classList.add('seleccionada');
        aplicarTipo(btn.dataset.tipo);
      });
    });

    // Afiliación: habilitar sueldo solo para relación de dependencia
    const afiliacion = document.getElementById('afiliacion');
    const sueldo = document.getElementById('sueldo');
    function syncSueldoEstado(){
      if(afiliacion.value === '1'){ sueldo.disabled = false; }
      else { sueldo.value = ''; sueldo.disabled = true; }
    }
    afiliacion.addEventListener('change', syncSueldoEstado);

    // Mapeo Proveedor -> ID (ajustar a tu DB si difiere)
    const PROVEEDOR_ID = {
      "Jerárquicos": 1,
      "DoctoRed": 2,
      "Swiss Medical": 3
    };

    // ----- Lógica principal -----
    const form  = document.getElementById('formCotizador');
    const tbody = document.getElementById('tbodyResultados');
    const btn   = document.getElementById('btnCotizar');
    const btnL  = document.getElementById('btnLimpiar');
    const fmtAR = new Intl.NumberFormat('es-AR', {style:'currency', currency:'ARS'});

    // Nuevo: refs para empty state y tabla
    const empty = document.getElementById('emptyState');
    const table = document.getElementById('tablaResultados');

    let __ULTIMOS_RESULTADOS = [];

    function showTable(){ table.hidden = false; empty.style.display = 'none'; }
    function showEmpty(msg){
      table.hidden = true;
      empty.style.display = 'flex';
      const title = empty.querySelector('.empty-title');
      const sub = empty.querySelector('.empty-sub');
      if(msg){ title.textContent = msg; sub.textContent = 'Proba cambiar la afiliación o los datos ingresados.'; }
    }

    function showSkeleton(rows=4){
      showTable();
      tbody.innerHTML = '';
      for(let i=0;i<rows;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div class="skeleton" style="width:40%;height:16px"></div></td>
          <td><div class="skeleton" style="width:70%;height:16px"></div></td>
          <td><div class="skeleton" style="width:50%;height:16px"></div></td>
          <td><div class="skeleton" style="width:40%;height:16px"></div></td>
          <td><div class="skeleton" style="width:60%;height:16px"></div></td>`;
        tbody.appendChild(tr);
      }
    }

    function estadoTexto(e){
      if(!e) return '—';
      e = String(e).replace(/_/g,' ').toLowerCase();
      return e.charAt(0).toUpperCase() + e.slice(1);
    }
    function num(n){ return Number(n || 0); }

    function renderRows(data){
      const items = Array.isArray(data) ? data : (data.items || []);
      __ULTIMOS_RESULTADOS = items;

      if (!items.length){
        showEmpty('No encontramos planes con esos datos');
        tbody.innerHTML = '';
        return;
      }

      showTable();
      tbody.innerHTML = '';
      items.forEach((p, i)=>{
        const precioFinal = num(p.valorFinal ?? p.precioFinal ?? p.valor);
        const tr = document.createElement('tr');
        tr.className = 'row-in';
        tr.style.animationDelay = (i*70)+'ms';
        tr.innerHTML = `
          <td>${p.proveedor ?? ''}</td>
          <td>${p.nombrePlan ?? p.plan ?? ''}</td>
          <td class="price-final">${fmtAR.format(precioFinal)}</td>
          <td class="estado">${estadoTexto(p.estado)}</td>
          <td><a href="#" class="link-detalle" onclick="abrirDetalle(${i});return false;">Ver detalle</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function postConsultar(body){
      const res = await fetch('/api/cotizador/consultar', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(txt || `HTTP ${res.status}`);
      }
      return res.json();
    }

    function buildRequestDTO(){
      const tipo = document.getElementById('tipoGrupo').value;
      const tienePareja = (tipo === 'pareja' || tipo === 'familia');
      const tieneHijos  = (tipo === 'hijos'  || tipo === 'familia');
      const cantHijos   = tieneHijos && !document.getElementById('grpCantidadHijos').classList.contains('hidden')
                          ? Number(document.getElementById('cantidadHijos').value || 0)
                          : 0;

      const proveedorTxt = document.getElementById('proveedor')?.value || '';
      const idProveedor  = PROVEEDOR_ID[proveedorTxt] || 0;
      const idPlan       = Number(document.getElementById('planes')?.value || 0);

      return {
        cantidad:        computeCantidad(tipo, cantHijos),
        edadTitular:     Number(document.getElementById('edadTitular').value || 0),
        generoTitular:   document.getElementById('genero').value || '',
        tienePareja:     tienePareja,
        generoPareja:    tienePareja ? (document.getElementById('generoPareja').value || 'N/A') : 'N/A',
        edadPareja:      tienePareja ? Number(document.getElementById('edadPareja').value || 0) : 0,
        tieneHijos:      tieneHijos,
        cantidadHijos:   tieneHijos ? cantHijos : 0,
        idAfiliacion:    Number(document.getElementById('afiliacion').value || 0),
        sueldoBruto:     !sueldo.disabled ? Number(sueldo.value || 0) : 0,
        idProveedor:     idProveedor,
        idPlan:          idPlan
      };
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      btn.classList.add('loading');
      showSkeleton(5);
      try {
        const dto = buildRequestDTO();
        const data = await postConsultar(dto);
        renderRows(data);
      } catch (err) {
        console.error(err);
        table.hidden = false; // mostrar tabla para ver el mensaje
        tbody.innerHTML = `<tr><td colspan="5" style="color:#b91c1c;padding:1rem">No pudimos cotizar: ${String(err.message).slice(0,300)}</td></tr>`;
      } finally {
        btn.classList.remove('loading');
      }
    });

    btnL.addEventListener('click', ()=>{
      form.reset();
      document.querySelectorAll('.opcion-familiar').forEach(b => b.classList.remove('seleccionada'));
      document.querySelector('.opcion-familiar[data-tipo="solo"]').classList.add('seleccionada');
      aplicarTipo('solo');
      syncSueldoEstado();
      showEmpty('Todavía no se realizaron cotizaciones');
      tbody.innerHTML = '';
    });

    // ----- Modal -----
    const backdrop = document.getElementById('detalleBackdrop');
    const cerrarDetalleBtn = document.getElementById('cerrarDetalle');
    const detalleContenido = document.getElementById('detalleContenido');

    async function postDetalle(id, body){
      const res = await fetch(`/api/cotizador/detalle/${id}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(txt || `HTTP ${res.status}`);
      }
      return res.json();
    }

    async function abrirDetalle(index){
      const p = __ULTIMOS_RESULTADOS[index] || {};
      const id = Number(p.idPlan ?? p.id ?? 0);
      if(!id){
        alert('No encontramos el ID del plan.');
        return;
      }

      const fmt = (v)=> (v !== null && v !== undefined)
        ? new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(Number(v))
        : '—';
      const afiMap = {1:'Relación de dependencia',2:'Monotributista',3:'Particular'};

      document.getElementById('detalleTitulo').textContent =
        `Detalle – ${(p.nombrePlan ?? p.plan ?? '')}${p.proveedor ? ' · '+p.proveedor : ''}`;
      detalleContenido.innerHTML = `
        <div class="grid">
          <div class="label">Precio base</div><div class="value"><div class="skeleton" style="height:16px"></div></div>
          <div class="label">Sueldo bruto</div><div class="value"><div class="skeleton" style="height:16px"></div></div>
          <div class="label">Aporte obra social</div><div class="value"><div class="skeleton" style="height:16px"></div></div>
          <div class="label">Total a pagar</div><div class="value"><div class="skeleton" style="height:16px"></div></div>
        </div>
      `;
      backdrop.classList.add('show');
      backdrop.setAttribute('aria-hidden','false');

      try {
        const dto = buildRequestDTO();
        const det = await postDetalle(id, dto);

        const fila = (label, val, opts={prefijo:''}) =>
          (val !== null && val !== undefined && Number(val) !== 0)
            ? `<div class="label">${label}</div><div class="value">${opts.prefijo}${fmt(val)}</div>`
            : '';

        detalleContenido.innerHTML = `
          <div class="grid" style="margin-bottom:.25rem">
            <div class="label">Precio base</div><div class="value">${fmt(det.valorPlan)}</div>
            ${fila('1er hijo', det.valorHijo)}
            ${fila('Hijo adicional', det.valorHijoAdicional)}
          </div>

          <hr style="border:none;border-top:1px solid #e2e8f0;margin:10px 0 12px">

          <div class="grid" style="margin-bottom:.25rem">
            <div class="label">Sueldo bruto</div><div class="value">${fmt(det.sueldoBruto)}</div>
            ${fila('Aporte obra social', det.aporteObraSocial, {prefijo:'-'})}
          </div>

          <hr style="border:none;border-top:1px solid #e2e8f0;margin:10px 0 12px">

          <div class="grid">
            <div class="label">Afiliación</div><div class="value">${afiMap[Number(det.afiliacion)] ?? '—'}</div>
            <div class="label">Personas</div><div class="value">${det.cantidadPersona ?? '—'}</div>
            <div class="label">Total a pagar</div><div class="total">${fmt(det.valorFinal)}</div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        detalleContenido.innerHTML =
          `<div style="color:#b91c1c">No pudimos cargar el detalle: ${String(err.message).slice(0,300)}</div>`;
      }
    }
    window.abrirDetalle = abrirDetalle;

    function cerrarDetalle(){
      backdrop.classList.remove('show');
      backdrop.setAttribute('aria-hidden','true');
    }
    cerrarDetalleBtn.addEventListener('click', cerrarDetalle);
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) cerrarDetalle(); });

    // Estado inicial
    aplicarTipo('solo');
    syncSueldoEstado();
    showEmpty('Todavía no se realizaron cotizaciones');
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>

